name: Deploy to AKS

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main]
    paths:
      - 'kubernetes/backend-kubernetes-ts/**'
      - 'kubernetes/frontend-kubernetes-ts/**'

env:
  # Azure Configuration
  AZURE_SUBSCRIPTION_ID: "74be1b16-c7f6-4ebd-88d0-c1754bef3200"
  
  # NBU Resource
  RESOURCE_GROUP: "rg-nbu-blog-k8s"
  AKS_CLUSTER: "aks-nbu-blog"
  CONTAINER_REGISTRY: "acrnbuk8s"
  
  # Application Configuration
  CUSTOM_DOMAIN: "devinsights.site"

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to Azure Container Registry
      run: az acr login --name ${{ env.CONTAINER_REGISTRY }}

    - name: Build and Push Backend Image
      run: |
        cd kubernetes/backend-kubernetes-ts
        docker build -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/nbu-blog-api:${{ github.sha }} .
        docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/nbu-blog-api:${{ github.sha }}

    - name: Build and Push Frontend Image
      run: |
        cd kubernetes/frontend-kubernetes-ts
        docker build \
          --build-arg REACT_APP_BACKEND_URL=https://api.${{ env.CUSTOM_DOMAIN }}/api \
          --build-arg REACT_APP_KEYCLOAK_URL=https://${{ env.CUSTOM_DOMAIN }}/auth \
          --build-arg REACT_APP_KEYCLOAK_REALM=it-blog-realm \
          --build-arg REACT_APP_KEYCLOAK_CLIENT_ID=it-blog-client \
          -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/nbu-blog-frontend:${{ github.sha }} \
          .
        docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/nbu-blog-frontend:${{ github.sha }}

    - name: Get AKS Credentials
      run: |
        az aks get-credentials \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.AKS_CLUSTER }} \
          --overwrite-existing

    - name: Update Image Tags in Manifests
      run: |
        # Update backend image tag
        sed -i "s|acrnbuk8s\.azurecr\.io/nbu-blog-api:.*|acrnbuk8s.azurecr.io/nbu-blog-api:${{ github.sha }}|g" kubernetes/backend-kubernetes-ts/aks-k8/*.yaml
        
        # Update frontend image tag
        sed -i "s|acrnbuk8s\.azurecr\.io/nbu-blog-frontend:.*|acrnbuk8s.azurecr.io/nbu-blog-frontend:${{ github.sha }}|g" kubernetes/frontend-kubernetes-ts/aks-k8/*.yaml

    - name: Deploy to AKS
      run: |
        # Deploy all backend components (including Keycloak)
        kubectl apply -f kubernetes/backend-kubernetes-ts/aks-k8/
        
        # Deploy frontend
        kubectl apply -f kubernetes/frontend-kubernetes-ts/aks-k8/

    - name: Wait for Deployments
      run: |
        kubectl rollout status deployment/blog-api --timeout=300s
        kubectl rollout status deployment/frontend --timeout=300s
        kubectl rollout status deployment/keycloak --timeout=600s

    - name: Show Status
      run: |
        echo "ðŸŽ‰ Deployment Complete!"
        echo ""
        kubectl get pods
        kubectl get svc
        kubectl get ingress